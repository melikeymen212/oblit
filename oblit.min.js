var f=(o,t)=>()=>(t||o((t={exports:{}}).exports,t),t.exports);var l=f((X,P)=>{P.exports={MAX:16384,HEAD:3,OP:{PING:1,PONG:2,BIN:3,JSON:4,STR:5},ERR:{SIZE:"E_SIZE",INC:"E_INC"}}});var y=f((Z,d)=>{var{MAX:w,HEAD:u,ERR:q}=l();d.exports={p:(o,t)=>{let e=Buffer.isBuffer(t)?t:Buffer.from(typeof t=="object"?JSON.stringify(t):String(t));if(e.length>w)throw new Error(q.SIZE);let r=Buffer.alloc(u);return r.writeUInt16BE(e.length,0),r.writeUInt8(o,2),Buffer.concat([r,e])},u:o=>{if(o.length<u)return null;let t=o.readUInt16BE(0),e=u+t;return o.length<e?null:{t:o.readUInt8(2),d:o.subarray(u,e),r:o.subarray(e)}}}});var E=f((k,g)=>{var R=require("net"),J=require("events"),{p:x,u:T}=y(),{MAX:A}=l(),O=class extends J{constructor(t){super(),this.port=t,this.c=new Set,this.srv=R.createServer(e=>this.h(e)),this.srv.on("error",e=>this.emit("error",e))}listen(t){let e=t||this.port;this.srv.listen(e,()=>this.emit("ready",e))}h(t){this.c.add(t),this.emit("connect",t);let e=Buffer.alloc(0);t.on("data",r=>{if(e.length+r.length>A*4){t.destroy();return}for(e=Buffer.concat([e,r]);;){let s=T(e);if(!s)break;this.emit("msg",t,s.t,s.d),e=s.r}}),t.on("error",r=>this.emit("clientError",t,r)),t.on("close",()=>{this.c.delete(t),this.emit("disconnect",t)})}bc(t,e){let r=x(t,e);for(let s of this.c)s.destroyed||s.write(r)}};g.exports=O});var m=f((G,I)=>{var D=require("net"),b=require("events"),{p:v,u:C}=y(),a=class extends b{constructor(t,e){super(),this.host=t,this.port=e,this.s=new D.Socket,this.s.setNoDelay(!0)}con(t,e){let r=t||this.host,s=e||this.port;this.s.connect(s,r,()=>this.emit("ready"));let c=Buffer.alloc(0);this.s.on("data",h=>{for(c=Buffer.concat([c,h]);;){let n=C(c);if(!n)break;this.emit("msg",n.t,n.d),c=n.r}}),this.s.on("close",()=>this.emit("close")),this.s.on("error",h=>this.emit("error",h))}send(t,e){this.s.write(v(t,e))}};I.exports=a});var U=E(),j=m(),i=l(),B=class{constructor(t){this.core=new U(t||3e3),this.isReady=!1,this.core.on("error",()=>{})}start(t){this.core.listen(this.core.port),this.core.on("ready",()=>{this.isReady=!0,t&&t(this.core.port)})}onData(t){this.core.on("msg",(e,r,s)=>{let c=s;if(r===i.OP.JSON)try{c=JSON.parse(s.toString())}catch{}else r===i.OP.STR&&(c=s.toString());t(c,n=>{let p=n,S=i.OP.STR;Buffer.isBuffer(n)?(p=n,S=i.OP.BIN):typeof n=="object"&&(p=JSON.stringify(n),S=i.OP.JSON),e.destroyed||this.core.bc(S,p)})})}},N=class{constructor(t){let[e,r]=(t||"127.0.0.1:3000").split(":");this.core=new j(e,parseInt(r))}connect(t){return new Promise(e=>{this.core.con(this.core.host,this.core.port),this.core.on("ready",()=>{t&&t(),e()})})}send(t){let e=i.OP.STR;Buffer.isBuffer(t)?e=i.OP.BIN:typeof t=="object"&&(t=JSON.stringify(t),e=i.OP.JSON),this.core.send(e,t)}onData(t){this.core.on("msg",(e,r)=>{let s=r;if(e===i.OP.JSON)try{s=JSON.parse(r.toString())}catch{}else e===i.OP.STR&&(s=r.toString());t(s)})}};module.exports={Server:B,Client:N,Constants:i,OP:i.OP};
